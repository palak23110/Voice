<%- include('../partials/header') %>

<main class="main-content page-blog-detail">
    <% if (typeof blog !== 'undefined' && blog) { %>
    <!-- Blog Banner Background -->
    <div class="blog-banner-bg" style="background-image: url('<%= blog.imageUrl || 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=1920&q=80' %>');"></div>
    <div class="blog-banner-overlay"></div>
    
    <div class="container">
        <article class="blog-detail" data-aos="fade-up">
            <div class="blog-header">
                <span class="blog-category-badge"><%= blog.category || 'Uncategorized' %></span>
                <h1 class="blog-title"><%= blog.title || 'Untitled Blog' %></h1>
                <div class="blog-meta">
                    <span class="blog-author">By <strong><%= blog.author || 'Anonymous' %></strong></span>
                    <span class="blog-date"><%= blog.createdAt ? new Date(blog.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Date unknown' %></span>
                    <span class="blog-views">üëÅ <%= blog.views || 0 %> views</span>
                </div>
            </div>

            <div class="blog-image" data-aos="zoom-in" data-aos-delay="100">
                <img src="<%= blog.imageUrl || 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=1920&q=80' %>" alt="<%= blog.title || 'Blog Image' %>" onerror="this.src='https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=1920&q=80'">
            </div>

            <div class="blog-content">
                <div class="blog-body" data-aos="fade-up" data-aos-delay="200">
                    <%= (blog.content || 'Content coming soon...').replace(/\n/g, '<br>') %>
                </div>

                <% if (blog.tags && blog.tags.length > 0) { %>
                    <div class="blog-tags" data-aos="fade-up" data-aos-delay="300">
                        <strong>Tags:</strong>
                        <% blog.tags.forEach(tag => { %>
                            <span class="tag"><%= tag %></span>
                        <% }); %>
                    </div>
                <% } %>

                <div class="blog-actions" data-aos="fade-up" data-aos-delay="400">
                    <% if (typeof user !== 'undefined' && user && user.id === blog.authorId.toString()) { %>
                        <a href="/blog/edit/<%= blog._id %>" class="btn btn-secondary">Edit Blog</a>
                        <form action="/blog/delete/<%= blog._id %>" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this blog?');">
                            <button type="submit" class="btn btn-danger">Delete Blog</button>
                        </form>
                    <% } %>
                </div>
            </div>
        </article>

        <!-- Comments Section -->
        <section class="comments-section" data-aos="fade-up" data-aos-delay="100">
            <h2>Comments (<%= comments ? comments.length : 0 %>)</h2>
            
            <% if (typeof user !== 'undefined' && user) { %>
                <form action="/blog/<%= blog._id %>/comment" method="POST" class="comment-form">
                    <textarea name="content" placeholder="Share your thoughts..." required></textarea>
                    <button type="submit" class="btn btn-primary">Post Comment</button>
                </form>
            <% } else { %>
                <p class="login-prompt">Please <a href="/auth/login">login</a> to post a comment.</p>
            <% } %>

            <div class="comments-list">
                <% if (comments && comments.length > 0) { %>
                    <% comments.forEach((comment, index) => { %>
                        <div class="comment-item" data-aos="fade-up" data-aos-delay="<%= index * 50 %>">
                            <div class="comment-author"><strong><%= comment.author %></strong></div>
                            <div class="comment-content"><%= comment.content %></div>
                            <div class="comment-date"><%= new Date(comment.createdAt).toLocaleDateString() %></div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <p class="no-comments">No comments yet. Be the first to share your thoughts!</p>
                <% } %>
            </div>
        </section>

        <!-- Related Blogs -->
        <% if (relatedBlogs && relatedBlogs.length > 0) { %>
            <section class="related-blogs" data-aos="fade-up" data-aos-delay="200">
                <h2>Related Blogs</h2>
                <div class="blogs-grid">
                    <% relatedBlogs.forEach((relatedBlog, index) => { %>
                        <div class="blog-card" data-aos="zoom-in" data-aos-delay="<%= index * 100 %>">
                            <div class="blog-card-image">
                                <img src="<%= relatedBlog.imageUrl || '/images/default-blog.jpg' %>" alt="<%= relatedBlog.title %>">
                                <span class="blog-category"><%= relatedBlog.category %></span>
                            </div>
                            <div class="blog-card-content">
                                <h3 class="blog-card-title"><a href="/blog/<%= relatedBlog._id %>"><%= relatedBlog.title %></a></h3>
                                <p class="blog-card-excerpt"><%= relatedBlog.excerpt %></p>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </section>
        <% } %>
    </div>
    <% } else { %>
    <div class="container">
        <div class="error-container">
            <div class="error-content" data-aos="zoom-in">
                <h1>Oops!</h1>
                <p class="error-message">Blog content is not available at this time.</p>
                <a href="/blog/list" class="btn btn-primary">Browse All Blogs</a>
            </div>
        </div>
    </div>
    <% } %>
</main>

<%- include('../partials/footer') %>
